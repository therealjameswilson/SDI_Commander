<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strategic Defense Initiative: FRUS 1981-1988 Interactive</title>
  <!-- (your existing styles unchanged) -->
  <style>
    /* ——— your entire existing <style> block stays exactly as-is ——— */
    /* (omitted here for brevity) */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <!-- These will be filled from XML if available -->
      <h1 id="seriesTitle">Foreign Relations</h1>
      <div class="subtitle">OF THE</div>
      <h1 id="seriesCountry">United States</h1>
      <div class="volume-info" id="volumeInfo">1981-1988<br>VOLUME XLIV, PART 1</div>
      <div class="great-seal">🦅</div>
      <h2 style="font-size:1.4em;margin-top:20px;" id="simTitle">
        STRATEGIC DEFENSE INITIATIVE<br/>INTERACTIVE SIMULATION
      </h2>
      <a id="canonicalLink" href="https://history.state.gov/historicaldocuments/frus1981-88v44p1"
         target="_blank" class="frus-link">VIEW ORIGINAL FRUS VOLUME</a>
    </div>

    <div class="game-area">
      <div class="main-panel">
        <!-- Optional: a doc selector populated from XML if <div type="document"> exists -->
        <div id="docSelectorWrap" style="display:none;margin-bottom:12px;">
          <label for="docSelect" style="font-weight:600;color:#8b3a21;">Load FRUS Document:</label>
          <select id="docSelect" style="margin-left:8px;padding:6px;border:1px solid #a04632;"></select>
          <button class="decision-button" style="width:auto;display:inline-block;margin-left:8px;"
                  id="loadDocBtn">Inject into Mission</button>
        </div>

        <div id="missionScreen">
          <h2 id="missionTitle">Document 147: Presidential Address on Strategic Defense</h2>
          <div class="document-text" id="missionBody">
            <p><strong>Date:</strong> March 23, 1983</p>
            <p><strong>Classification:</strong> UNCLASSIFIED</p>
            <p><strong>Source:</strong> Public Papers of President Reagan</p>

            <p>The President announced tonight a comprehensive research program to explore the possibility of eliminating the threat posed by strategic nuclear missiles. This initiative, to be managed by the Department of Defense in coordination with the National Security Council, represents a fundamental shift in U.S. strategic doctrine.</p>

            <p>You have been appointed as Program Director for what will become known as the Strategic Defense Initiative. Your mandate includes:</p>
            <p>1. Developing and evaluating defensive technologies across multiple domains (space-based, ground-based, and directed energy systems)</p>
            <p>2. Managing Congressional appropriations and maintaining bipartisan support</p>
            <p>3. Coordinating with allied governments while preserving technological advantages</p>
            <p>4. Navigating arms control implications and Soviet diplomatic responses</p>

            <p>Initial budget authorization: $3.8 billion (FY1985)</p>
            <p>Initial political support: Moderate (65%)</p>
            <p>Soviet ICBM inventory: 1,398 deployed missiles</p>
          </div>
          <button class="decision-button" onclick="startGame()">Accept Presidential Appointment</button>
        </div>

        <div id="gameScreen" style="display:none;">
          <h2>Strategic Defense Initiative - Technology Development</h2>
          <div class="tech-grid" id="techGrid"></div>
        </div>

        <div class="defense-screen" id="defenseScreen">
          <h2 style="color:#f4e5c2;margin-bottom:20px;">Defense Engagement System</h2>
          <div class="radar-display"><div class="radar-sweep"></div></div>
        </div>

        <div class="decision-panel" id="decisionPanel">
          <div class="decision-title" id="decisionTitle"></div>
          <div class="decision-text" id="decisionText"></div>
          <div class="decision-options" id="decisionOptions"></div>
        </div>

        <div class="message-log" id="messageLog">
          <div class="message">System initialized. Awaiting orders...</div>
        </div>
      </div>

      <div class="sidebar">
        <h3>PROGRAM STATUS</h3>
        <div class="resource">
          <div class="resource-label">Budget Authorization</div>
          <div class="resource-value" id="budget">$3.8B</div>
          <div class="progress-bar"><div class="progress-fill" id="budgetBar" style="width:38%"></div></div>
        </div>
        <div class="resource">
          <div class="resource-label">Research Progress</div>
          <div class="resource-value" id="research">0</div>
          <div class="progress-bar"><div class="progress-fill" id="researchBar" style="width:0%"></div></div>
        </div>
        <div class="resource">
          <div class="resource-label">Congressional Support</div>
          <div class="resource-value" id="political">65%</div>
          <div class="progress-bar"><div class="progress-fill" id="politicalBar" style="width:65%"></div></div>
        </div>
        <div class="resource">
          <div class="resource-label">Defense Capability</div>
          <div class="resource-value" id="defense">0%</div>
          <div class="progress-bar"><div class="progress-fill" id="defenseBar" style="width:0%"></div></div>
        </div>
        <div class="stats-panel">
          <h4>OPERATIONAL DATA</h4>
          <div class="stat-item"><span class="stat-label">Fiscal Year:</span><span class="stat-value" id="currentYear">1983</span></div>
          <div class="stat-item"><span class="stat-label">Technologies:</span><span class="stat-value" id="techCount">0</span></div>
          <div class="stat-item"><span class="stat-label">Interceptors:</span><span class="stat-value" id="interceptorCount">0</span></div>
          <div class="stat-item"><span class="stat-label">Test Success Rate:</span><span class="stat-value" id="successRate">N/A</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="threat-indicator" id="threatIndicator">
    <div class="threat-level">⚠ STRATEGIC ALERT ⚠</div>
    <div style="text-align:center;margin:10px 0;">Inbound ICBMs Detected</div>
    <div class="missile-count" id="missileCount">0</div>
  </div>

  <!-- ================= SDI Game Logic + TEI Loader ================= -->
  <script>
    // ---------- SDI GAME STATE (unchanged from your version) ----------
    const gameState = { year:1983,budget:3.8,maxBudget:10,research:0,maxResearch:1000,political:65,defense:0,technologies:[],interceptors:0,testsRun:0,testsSuccessful:0,currentDecision:null,gameStarted:false };

    const technologies = [
      {id:'hoe',name:'Homing Overlay Experiment (HOE)',description:'Kinetic energy interceptor system',cost:0.5,researchCost:100,defenseBonus:10,type:'midcourse'},
      {id:'miracl',name:'MIRACL Chemical Laser',description:'Mid-Infrared Advanced Chemical Laser',cost:1.2,researchCost:200,defenseBonus:15,type:'boost'},
      {id:'eris',name:'ERIS System',description:'Exoatmospheric Reentry-vehicle Interceptor',cost:0.8,researchCost:150,defenseBonus:12,type:'terminal'},
      {id:'sbi',name:'Space-Based Interceptors',description:'Orbital kinetic kill vehicles',cost:3.0,researchCost:500,defenseBonus:25,type:'boost'},
      {id:'bsts',name:'Boost Surveillance & Tracking',description:'Early warning satellite constellation',cost:1.5,researchCost:250,defenseBonus:20,type:'sensor'},
      {id:'brilliant',name:'Brilliant Pebbles',description:'Autonomous orbital interceptors',cost:2.5,researchCost:400,defenseBonus:30,type:'midcourse'},
      {id:'xray',name:'X-Ray Laser (Excalibur)',description:'Nuclear-pumped directed energy',cost:5.0,researchCost:800,defenseBonus:40,type:'boost'},
      {id:'neutral',name:'Neutral Particle Beam',description:'Discrimination and kill assessment',cost:2.0,researchCost:350,defenseBonus:18,type:'midcourse'}
    ];

    const decisions = [
      { id:'treaty84', year:1984, title:'NSC Meeting: ABM Treaty Interpretation',
        text:'The Legal Adviser and Defense Department present conflicting interpretations of ABM Treaty constraints. DoD argues for "broad interpretation" permitting development and testing of space-based systems. State Department warns this could collapse arms control negotiations.',
        options:[ {text:'Support broad interpretation - Accelerate space-based development',effects:{political:-20,research:200,defense:10}},
                  {text:'Maintain traditional interpretation - Preserve diplomatic options',effects:{political:10,research:50,defense:5}} ]},
      { id:'congress85', year:1985, title:'Congressional Budget Resolution',
        text:'House Armed Services Committee proposes 40% reduction in SDI funding. Senator Nunn questions program feasibility. Pentagon requests emergency supplemental appropriation.',
        options:[ {text:'Mobilize Presidential support for full funding',effects:{budget:Math.random()>0.5?2:-1.5,political:-15}},
                  {text:'Accept Committee recommendations',effects:{budget:-0.8,political:5}},
                  {text:'Trade MX missile program for SDI funding',effects:{budget:1,political:15,defense:-5}} ]},
      { id:'reykjavik86', year:1986, title:'Reykjavik Summit Crisis',
        text:'General Secretary Gorbachev proposes elimination of all ballistic missiles contingent on SDI laboratory restriction for 10 years. President Reagan must respond.',
        options:[ {text:'Accept laboratory limitations - Historic arms reduction',effects:{political:25,defense:-20,research:-300}},
                  {text:'Reject Soviet proposal - Preserve SDI development',effects:{political:-10,defense:15,research:100}} ]},
      { id:'phase87', year:1987, title:'Phase I Architecture Decision',
        text:'SDIO presents deployment options to NSC. Space-based architecture offers superior coverage but raises treaty concerns. Ground-based system is treaty-compliant but provides limited defense.',
        options:[ {text:'Approve space-based architecture',effects:{defense:20,political:-15,budget:-2}},
                  {text:'Select ground-based deployment',effects:{defense:10,political:10,budget:-1}},
                  {text:'Defer deployment decision pending further research',effects:{research:150,political:5,defense:5}} ]}
    ];

    // ---------- TEI XML LOADER ----------
    const TEI_FILE = 'frus1981-88v47p1.xml'; // must live next to this HTML

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch(TEI_FILE);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const xmlText = await res.text();

        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, 'application/xml');

        if (xml.querySelector('parsererror')) throw new Error('XML parse error');

        hydrateHeaderFromTEI(xml);
        populateDocsFromTEI(xml);
        addMessage('FRUS TEI loaded successfully', 'success');
      } catch (e) {
        addMessage(`Could not load TEI (“${TEI_FILE}”): ${e.message}. Using built-in mission.`, 'warning');
      }
    });

    function textOf(node) { return node ? (node.textContent || '').trim() : ''; }

    function hydrateHeaderFromTEI(xml) {
      const ns = 'http://www.tei-c.org/ns/1.0';
      const titleNodes = xml.getElementsByTagNameNS(ns, 'title');
      let completeTitle = '', series = '', subseries = '', volumeNum = '', volume = '';
      [...titleNodes].forEach(t => {
        const type = t.getAttribute('type') || '';
        if (type === 'complete') completeTitle = textOf(t);
        else if (type === 'series') series = textOf(t);
        else if (type === 'sub-series') subseries = textOf(t);
        else if (type === 'volume-number') volumeNum = textOf(t);
        else if (type === 'volume') volume = textOf(t);
      });

      const editor = textOf(xml.querySelector('teiHeader titleStmt editor'));
      const canonical = xml.querySelector('teiHeader notesStmt relatedItem[type="canonical"]');
      const canonicalHref = canonical ? canonical.getAttribute('target') : null;

      // Header branding
      document.getElementById('seriesTitle').textContent = series || 'Foreign Relations';
      document.getElementById('seriesCountry').textContent = 'United States';
      const vi = [subseries || '1981–1988', volumeNum || '', volume || ''].filter(Boolean).join('<br>');
      document.getElementById('volumeInfo').innerHTML = vi || '1981–1988';

      if (canonicalHref) {
        const a = document.getElementById('canonicalLink');
        a.href = canonicalHref;
        a.textContent = 'VIEW CANONICAL FRUS PAGE';
      }

      // Add editor credit to the sim subtitle if available
      if (editor) {
        const sim = document.getElementById('simTitle');
        sim.innerHTML = sim.innerHTML + `<div style="font-size:.8em;opacity:.9;margin-top:6px;">Editor: ${editor}</div>`;
      }

      // If body has a general note, insert it as a preface paragraph in the mission
      const bodyPara = xml.querySelector('text body p');
      if (bodyPara) {
        const body = document.getElementById('missionBody');
        const p = document.createElement('p');
        p.innerHTML = `<em>${bodyPara.textContent.trim()}</em>`;
        body.insertBefore(p, body.firstChild);
      }
    }

    function populateDocsFromTEI(xml) {
      const ns = 'http://www.tei-c.org/ns/1.0';
      // Typical FRUS markup has <div type="document">. Your uploaded file is a header/status stub,
      // but this supports full docs if you replace with a populated TEI later.
      const docDivs = xml.querySelectorAll('div[type="document"]');

      if (!docDivs.length) {
        // Show selector is not needed
        document.getElementById('docSelectorWrap').style.display = 'none';
        return;
      }

      const select = document.getElementById('docSelect');
      select.innerHTML = '';
      docDivs.forEach((div, i) => {
        const head = div.querySelector('head');
        const dateNode = div.querySelector('date');
        const num = div.getAttribute('n') || (i + 1);
        const opt = document.createElement('option');
        opt.value = i.toString();
        opt.textContent = `Document ${num}: ${head ? head.textContent.trim() : '(Untitled)'}${dateNode ? ' — ' + dateNode.textContent.trim() : ''}`;
        select.appendChild(opt);
      });

      document.getElementById('docSelectorWrap').style.display = 'block';

      document.getElementById('loadDocBtn').onclick = () => {
        const idx = parseInt(select.value, 10);
        const div = docDivs[idx];
        injectDocIntoMission(div);
      };
    }

    function injectDocIntoMission(div) {
      // Extract common fields
      const head = div.querySelector('head');
      const when = div.querySelector('date')?.getAttribute('when') || '';
      const dateText = div.querySelector('date')?.textContent?.trim() || when || 'N.d.';
      const classification = div.querySelector('[type="classification"]')?.textContent?.trim() || '';
      const source = div.querySelector('[type="source"]')?.textContent?.trim() || '';

      // Join the first 3 paragraphs as a brief
      const paras = [...div.querySelectorAll('p')].slice(0,3).map(p => p.textContent.trim());
      const brief = paras.length ? paras.join('</p><p>') : 'No summary available in this document.';

      // Update UI
      document.getElementById('missionTitle').textContent =
        (head ? head.textContent.trim() : 'FRUS Document') + (when ? ` (${when})` : '');
      document.getElementById('missionBody').innerHTML = `
        <p><strong>Date:</strong> ${dateText}</p>
        ${classification ? `<p><strong>Classification:</strong> ${classification}</p>` : ''}
        ${source ? `<p><strong>Source:</strong> ${source}</p>` : ''}
        <p>${brief}</p>
      `;

      addMessage('Loaded mission briefing from selected FRUS document', 'success');
    }

    // ---------- SDI GAME FUNCTIONS (unchanged) ----------
    function startGame(){ gameState.gameStarted=true;
      document.getElementById('missionScreen').style.display='none';
      document.getElementById('gameScreen').style.display='block';
      renderTechnologies(); updateUI();
      addMessage('SDI Program activated per Presidential directive','success');
      addMessage('Initial appropriation: $3.8 billion (FY1985)','');
      setInterval(gameLoop,1000);
      setInterval(yearlyUpdate,12000);
    }

    function renderTechnologies(){
      const grid=document.getElementById('techGrid'); grid.innerHTML='';
      technologies.forEach(tech=>{
        const isResearched=gameState.technologies.includes(tech.id);
        const canAfford=gameState.budget>=tech.cost && gameState.research>=tech.researchCost;
        const card=document.createElement('div');
        card.className=`tech-card ${isResearched?'researched':''} ${!canAfford && !isResearched ? 'locked':''}`;
        card.innerHTML=`
          <div class="tech-name">${tech.name}</div>
          <div class="tech-description">${tech.description}</div>
          <div class="tech-cost">${isResearched ? 'STATUS: OPERATIONAL' : \`Requirements: $\${tech.cost}B | \${tech.researchCost} RP\`}</div>`;
        if(!isResearched && canAfford){ card.onclick=()=>researchTechnology(tech); }
        grid.appendChild(card);
      });
    }

    function researchTechnology(tech){
      if(gameState.budget>=tech.cost && gameState.research>=tech.researchCost){
        gameState.budget-=tech.cost; gameState.research-=tech.researchCost;
        gameState.technologies.push(tech.id);
        gameState.defense+=tech.defenseBonus; gameState.political+=5;
        gameState.testsRun++; gameState.testsSuccessful++;
        if(tech.type==='midcourse'||tech.type==='terminal'){
          gameState.interceptors+=Math.floor(tech.defenseBonus/2);
        }
        addMessage(`${tech.name} deployment authorized and operational`,'success');
        renderTechnologies(); updateUI();
      }
    }

    function triggerDecision(decision){
      if(gameState.currentDecision) return;
      gameState.currentDecision=decision;
      const panel=document.getElementById('decisionPanel');
      panel.className='decision-panel active';
      document.getElementById('decisionTitle').textContent=decision.title;
      document.getElementById('decisionText').textContent=decision.text;
      const optionsDiv=document.getElementById('decisionOptions'); optionsDiv.innerHTML='';
      decision.options.forEach((opt,i)=>{
        const b=document.createElement('button');
        b.className='decision-button'; b.textContent=opt.text; b.onclick=()=>makeDecision(i);
        optionsDiv.appendChild(b);
      });
      addMessage(`PRIORITY: ${decision.title}`,'critical');
    }

    function makeDecision(optionIndex){
      const decision=gameState.currentDecision; const option=decision.options[optionIndex];
      Object.keys(option.effects).forEach(key=>{
        if(key==='budget'){ gameState[key]=Math.max(0,Math.min(gameState.maxBudget,gameState[key]+option.effects[key])); }
        else if(key==='research'){ gameState[key]=Math.max(0,Math.min(gameState.maxResearch,gameState[key]+option.effects[key])); }
        else { gameState[key]=Math.max(0,Math.min(100,gameState[key]+option.effects[key])); }
      });
      addMessage(`Decision recorded: ${decision.title}`,'warning');
      document.getElementById('decisionPanel').className='decision-panel';
      gameState.currentDecision=null; updateUI();
    }

    function simulateMissileAttack(missileCount){
      addMessage(`FLASH PRIORITY: ${missileCount} Soviet ICBMs detected by NORAD`,'critical');
      document.getElementById('threatIndicator').className='threat-indicator active';
      document.getElementById('missileCount').textContent=missileCount;
      const defenseScreen=document.getElementById('defenseScreen');
      defenseScreen.className='defense-screen active';
      document.getElementById('gameScreen').style.display='none';
      gameState.testsRun++;
      let destroyed=0; const p=Math.min(0.9,gameState.defense/100);
      for(let i=0;i<missileCount;i++){ if(Math.random()<p) destroyed++; }
      if(destroyed>0) gameState.testsSuccessful++;
      setTimeout(()=>{
        const survived=missileCount-destroyed;
        if(survived===0){ addMessage(`DEFENSE SUCCESS: All ${missileCount} targets neutralized`,'success'); gameState.political=Math.min(100,gameState.political+20); }
        else if(survived<missileCount/2){ addMessage(`PARTIAL SUCCESS: ${destroyed}/${missileCount} intercepted, ${survived} leaked through`,'warning'); gameState.political+=5; }
        else { addMessage(`DEFENSE FAILURE: Only ${destroyed}/${missileCount} intercepted`,'critical'); gameState.political=Math.max(0,gameState.political-20); }
        document.getElementById('threatIndicator').className='threat-indicator';
        defenseScreen.className='defense-screen';
        document.getElementById('gameScreen').style.display='block';
        updateUI();
      },5000);
    }

    function gameLoop(){
      if(!gameState.gameStarted) return;
      gameState.research=Math.min(gameState.maxResearch,gameState.research + gameState.technologies.length*2);
      if(Math.random()<0.001){ simulateMissileAttack(Math.floor(Math.random()*10)+1); }
      updateUI();
    }

    function yearlyUpdate(){
      if(!gameState.gameStarted) return;
      gameState.year++; gameState.budget=Math.min(gameState.maxBudget,gameState.budget+2);
      addMessage(`FY${gameState.year} Congressional appropriation received`,'');
      const dec=decisions.find(d=>d.year===gameState.year); if(dec) triggerDecision(dec);
      if(Math.random()<0.3 && !gameState.currentDecision){
        const delta=(Math.random()-0.5)*1.5;
        gameState.budget=Math.max(0.5,Math.min(gameState.maxBudget,gameState.budget+delta));
        addMessage(delta>0?`Congress approves $${Math.abs(delta).toFixed(1)}B supplemental`:`Budget reduction: $${Math.abs(delta).toFixed(1)}B`, delta>0?'success':'warning');
      }
      if(gameState.year>=1993){
        if(gameState.defense>=50){
          alert(`MISSION ACCOMPLISHED\n\nYou successfully developed and deployed the Strategic Defense Initiative.\n\nFinal Defense Capability: ${gameState.defense}%\nTechnologies Deployed: ${gameState.technologies.length}`);
        } else {
          alert(`PROGRAM TERMINATED\n\nSDI failed to achieve minimum viable defense capability.\n\nFinal Defense Capability: ${gameState.defense}%`);
        }
        location.reload();
      }
      updateUI();
    }
