
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Defense Initiative: FRUS 1981-1988 Interactive</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Source+Serif+Pro:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Crimson Text', 'Georgia', serif;
            background: #f4f1e8;
            color: #2c1810;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #8b3a21 0%, #a04632 100%);
            color: #f4e5c2;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23fff" opacity="0.03"/><circle cx="50" cy="50" r="40" fill="none" stroke="%23fff" stroke-width="0.5" opacity="0.1"/></svg>');
            background-size: 100px 100px;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.1em;
            letter-spacing: 2px;
            margin-bottom: 15px;
            opacity: 0.95;
        }
        
        .volume-info {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        
        .great-seal {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            background: radial-gradient(circle, #f4e5c2 30%, #d4c5a2 70%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .frus-link {
            display: inline-block;
            color: #f4e5c2;
            text-decoration: none;
            border: 1px solid #f4e5c2;
            padding: 8px 20px;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        
        .frus-link:hover {
            background: rgba(244, 229, 194, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .game-area {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-top: 20px;
        }
        
        .main-panel {
            background: white;
            border: 2px solid #8b3a21;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .main-panel h2 {
            color: #8b3a21;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b3a21;
            letter-spacing: 1px;
        }
        
        .sidebar {
            background: white;
            border: 2px solid #8b3a21;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sidebar h3 {
            color: #8b3a21;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #8b3a21;
            letter-spacing: 1px;
        }
        
        .resource {
            margin-bottom: 20px;
            padding: 12px;
            background: #faf8f3;
            border-left: 3px solid #a04632;
        }
        
        .resource-label {
            font-size: 0.85em;
            color: #8b3a21;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .resource-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c1810;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e8e4d9;
            border: 1px solid #8b3a21;
            margin-top: 8px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b3a21, #a04632);
            transition: width 0.3s ease;
        }
        
        .document-text {
            background: #faf8f3;
            border-left: 3px solid #8b3a21;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.05em;
            line-height: 1.7;
            color: #2c1810;
        }
        
        .document-text p {
            margin-bottom: 15px;
        }
        
        .document-text strong {
            color: #8b3a21;
            font-weight: 600;
        }
        
        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .tech-card {
            background: #faf8f3;
            border: 1px solid #a04632;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tech-card:hover {
            box-shadow: 0 4px 8px rgba(139, 58, 33, 0.2);
            transform: translateY(-2px);
        }
        
        .tech-card.researched {
            background: #e8f4e8;
            border-color: #4a7c59;
        }
        
        .tech-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .tech-name {
            font-weight: 600;
            color: #8b3a21;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .tech-description {
            font-size: 0.9em;
            color: #5c4033;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .tech-cost {
            font-size: 0.85em;
            color: #8b3a21;
            font-weight: 600;
            padding-top: 8px;
            border-top: 1px solid #d4c5a2;
        }
        
        .decision-panel {
            background: white;
            border: 3px solid #8b3a21;
            padding: 25px;
            margin-top: 20px;
            display: none;
            box-shadow: 0 4px 12px rgba(139, 58, 33, 0.3);
        }
        
        .decision-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .decision-title {
            font-size: 1.6em;
            color: #8b3a21;
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b3a21;
        }
        
        .decision-text {
            margin-bottom: 20px;
            line-height: 1.7;
            color: #2c1810;
        }
        
        .decision-button {
            background: linear-gradient(135deg, #8b3a21 0%, #a04632 100%);
            color: #f4e5c2;
            border: none;
            padding: 12px 20px;
            margin: 8px 0;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
        }
        
        .decision-button:hover {
            box-shadow: 0 4px 8px rgba(139, 58, 33, 0.3);
            transform: translateX(5px);
        }
        
        .message-log {
            background: #faf8f3;
            border: 1px solid #8b3a21;
            padding: 15px;
            height: 180px;
            overflow-y: auto;
            margin-top: 20px;
            font-size: 0.95em;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #a04632;
            padding-left: 12px;
            background: white;
        }
        
        .message.warning {
            border-left-color: #d4a017;
            background: #fff9e6;
        }
        
        .message.critical {
            border-left-color: #8b3a21;
            background: #ffebe6;
            font-weight: 600;
        }
        
        .message.success {
            border-left-color: #4a7c59;
            background: #e8f4e8;
        }
        
        .threat-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 3px solid #8b3a21;
            padding: 20px;
            min-width: 220px;
            display: none;
            box-shadow: 0 4px 12px rgba(139, 58, 33, 0.4);
        }
        
        .threat-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(139, 58, 33, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(139, 58, 33, 0.6); }
        }
        
        .threat-level {
            font-size: 1.2em;
            font-weight: 600;
            color: #8b3a21;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .missile-count {
            color: #8b3a21;
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            margin-top: 10px;
        }
        
        .defense-screen {
            display: none;
            background: #2c1810;
            border: 3px solid #8b3a21;
            padding: 20px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .defense-screen.active {
            display: block;
        }
        
        .radar-display {
            width: 100%;
            height: 350px;
            background: radial-gradient(circle at center, #1a3a1a, #0d1a0d);
            border: 2px solid #4a7c59;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4a7c59, transparent);
            transform-origin: left center;
            animation: sweep 4s linear infinite;
        }
        
        @keyframes sweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .stats-panel {
            background: #faf8f3;
            border: 1px solid #8b3a21;
            padding: 15px;
            margin-top: 15px;
        }
        
        .stats-panel h4 {
            color: #8b3a21;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted #d4c5a2;
        }
        
        .stat-label {
            color: #5c4033;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-weight: 600;
            color: #8b3a21;
        }
        
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .tech-grid {
                grid-template-columns: 1fr;
            }
        }
        .badge {
  display: inline-block;
  margin-left: 8px;
  padding: 2px 10px;
  font-size: 0.75em;
  font-weight: 700;
  border-radius: 12px;
  border: 1px solid #4a7c59;
  background: #4a7c59;
  color: #fff;
  vertical-align: middle;
  letter-spacing: 0.5px;
}
.badge.off {
  border-color: #8a8a8a;
  background: #8a8a8a;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Foreign Relations</h1>
            <div class="subtitle">OF THE</div>
            <h1>United States</h1>
            <div class="volume-info">1981-1988<br>VOLUME XLIV, PART 1</div>
            <div class="great-seal">🦅</div>
            <h2 style="font-size: 1.4em; margin-top: 20px;">STRATEGIC DEFENSE INITIATIVE<br>INTERACTIVE SIMULATION</h2>
            <a href="https://history.state.gov/historicaldocuments/frus1981-88v44p1" target="_blank" class="frus-link">VIEW ORIGINAL FRUS VOLUME</a>
        </div>
        
        <div class="game-area">
            <div class="main-panel">
                <div id="missionScreen">
                    <h2>Document 147: Presidential Address on Strategic Defense</h2>
                    <div class="document-text">
                        <p><strong>Date:</strong> March 23, 1983</p>
                        <p><strong>Classification:</strong> UNCLASSIFIED</p>
                        <p><strong>Source:</strong> Public Papers of President Reagan</p>
                        
                        <p>The President announced tonight a comprehensive research program to explore the possibility of eliminating the threat posed by strategic nuclear missiles. This initiative, to be managed by the Department of Defense in coordination with the National Security Council, represents a fundamental shift in U.S. strategic doctrine.</p>
                        
                        <p>You have been appointed as Program Director for what will become known as the Strategic Defense Initiative. Your mandate includes:</p>
                        
                        <p>1. Developing and evaluating defensive technologies across multiple domains (space-based, ground-based, and directed energy systems)</p>
                        <p>2. Managing Congressional appropriations and maintaining bipartisan support</p>
                        <p>3. Coordinating with allied governments while preserving technological advantages</p>
                        <p>4. Navigating arms control implications and Soviet diplomatic responses</p>
                        
                        <p>Initial budget authorization: $3.8 billion (FY1985)</p>
                        <p>Initial political support: Moderate (65%)</p>
                        <p>Soviet ICBM inventory: 1,398 deployed missiles</p>
                    </div>
                    <button class="decision-button" onclick="startGame()">Accept Presidential Appointment</button>
                </div>
                
                <div id="gameScreen" style="display: none;">
                    <h2>Strategic Defense Initiative - Technology Development</h2>
<!-- ===== SDI PLANNER (pick up to 3) ===== -->
<div id="sdiPlanner" style="display:none; margin-top:16px;">
  <h2>NSC SDI Guidance — Select up to 3 Focus Areas</h2>
  <p style="margin-bottom:10px;">Choose at most three SDI thrusts and allocate this month’s R&amp;D effort. These are derived from FRUS references (fallback to defaults if FRUS not loaded).</p>
  <div id="sdiTrackList" class="tech-grid"></div>
  <div id="sdiAllocPanel" style="display:none; margin-top:12px; background:#faf8f3; border:1px solid #a04632; padding:12px;">
    <div style="font-weight:600; color:#8b3a21; margin-bottom:8px;">Monthly R&amp;D Allocation (must equal 100%)</div>
    <div id="sdiAllocRows"></div>
    <div style="margin-top:8px; font-size:0.9em;">Total: <span id="sdiAllocTotal">0</span>%</div>
    <button class="decision-button" id="saveSdiPlanBtn">Save SDI Plan</button>
  </div>
</div>

<!-- ===== MX / PEACEKEEPER BASING PANE ===== -->
<div id="mxPane" style="display:none; margin-top:16px;">
  <h2>MX / Peacekeeper Basing Options</h2>
  <div id="mxDocsNote" class="document-text" style="margin-top:0;">
    Relevant options will appear in months where the FRUS volume discusses MX/Peacekeeper/basing. Otherwise this section stays quiet.
  </div>
  <div id="mxOptions" class="decision-options"></div>
</div>

<!-- Quick access buttons -->
<div style="display:flex; gap:8px; margin-top:8px;">
  <button class="decision-button" id="openPlannerBtn">Open SDI Planner</button>
  <button class="decision-button" id="openMXBtn">Open MX Basing</button>
</div>


                    <!-- R&D Allocation Panel -->
<div id="rdPanel" style="background:#faf8f3;border:1px solid #a04632;padding:14px;margin:10px 0;">
  <div style="font-weight:600;color:#8b3a21;margin-bottom:8px;">R&D Allocation (NSC Guidance)</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <div>
      <label style="font-size:0.9em;color:#5c4033;">R&D Budget per Month ($B): 
        <input id="rdMonthly" type="range" min="0" max="3" step="0.1" value="0.6"
               style="width:100%;margin-top:6px;">
      </label>
      <div style="display:flex;justify-content:space-between;font-size:0.9em;color:#5c4033;">
        <span>0</span><span id="rdMonthlyLabel">0.6</span><span>3.0</span>
      </div>
      <div style="font-size:0.85em;color:#5c4033;margin-top:6px;">
        Funds convert to research automatically each month. If the program runs short of budget, actual spend is capped.
      </div>
    </div>
    <div>
      <div style="display:grid;grid-template-columns:1fr 60px;gap:6px;align-items:center;margin-bottom:6px;">
        <label>Boost</label><input id="allocBoost" type="number" min="0" max="100" step="1" value="25">
        <label>Midcourse</label><input id="allocMid" type="number" min="0" max="100" step="1" value="25">
        <label>Terminal</label><input id="allocTerm" type="number" min="0" max="100" step="1" value="25">
        <label>Sensor</label><input id="allocSens" type="number" min="0" max="100" step="1" value="25">
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button id="btnNormalize" class="decision-button" style="flex:1;">Normalize (100%)</button>
        <button id="btnEven" class="decision-button" style="flex:1;">Even Split</button>
      </div>
      <div id="allocWarn" style="font-size:0.85em;color:#8b3a21;margin-top:6px;"></div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px;font-size:0.9em;color:#5c4033;">
    <div>Boost RP pool: <span id="rpBoost">0</span></div>
    <div>Midcourse RP pool: <span id="rpMid">0</span></div>
    <div>Terminal RP pool: <span id="rpTerm">0</span></div>
    <div>Sensor RP pool: <span id="rpSens">0</span></div>
  </div>
</div>

                    <div class="tech-grid" id="techGrid"></div>
                </div>
                
                <div class="defense-screen" id="defenseScreen">
                    <h2 style="color: #f4e5c2; margin-bottom: 20px;">Defense Engagement System</h2>
                    <div class="radar-display">
                        <div class="radar-sweep"></div>
                    </div>
                </div>
                
                <div class="decision-panel" id="decisionPanel">
                    <div class="decision-title" id="decisionTitle"></div>
                    <div class="decision-text" id="decisionText"></div>
                    <div class="decision-options" id="decisionOptions"></div>
                </div>
                
                <div class="message-log" id="messageLog">
                    <div class="message">System initialized. Awaiting orders...</div>
                </div>
            </div>
            
            <div class="sidebar">
                <h3>
PROGRAM STATUS
  <span id="frusBadge" class="badge off" title="FRUS XML not loaded">FRUS FALLBACK</span>
</h3>

                
                <div class="resource">
                    <div class="resource-label">Budget Authorization</div>
                    <div class="resource-value" id="budget">$3.8B</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="budgetBar" style="width: 38%"></div>
                    </div>
                </div>
                
                <div class="resource">
                    <div class="resource-label">Research Progress</div>
                    <div class="resource-value" id="research">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="researchBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="resource">
                    <div class="resource-label">Congressional Support</div>
                    <div class="resource-value" id="political">65%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="politicalBar" style="width: 65%"></div>
                    </div>
                </div>
                
                <div class="resource">
                    <div class="resource-label">Defense Capability</div>
                    <div class="resource-value" id="defense">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="defenseBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <h4>OPERATIONAL DATA</h4>
                    <div class="stat-item">
                        <span class="stat-label">Fiscal Year:</span>
                        <span class="stat-value" id="currentYear">1983</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Technologies:</span>
                        <span class="stat-value" id="techCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Interceptors:</span>
                        <span class="stat-value" id="interceptorCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Test Success Rate:</span>
                        <span class="stat-value" id="successRate">N/A</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="threat-indicator" id="threatIndicator">
        <div class="threat-level">⚠ STRATEGIC ALERT ⚠</div>
        <div style="text-align: center; margin: 10px 0;">Inbound ICBMs Detected</div>
        <div class="missile-count" id="missileCount">0</div>
    </div>


<script>
// ===================== GAME LOGIC (WITH R&D ALLOCATION) =====================

// --- Constants for R&D conversion ---
const RP_PER_BILLION = 150;     // 1.0 $B => 150 RP (tuneable)
const SECS_PER_MONTH = 30 * 24 * 60 * 60;

// Game State
const gameState = {
  year: 1985,
  budget: 3.8,
  maxBudget: 10,
  research: 0,          // global, untyped RP
  maxResearch: 1000,
  political: 65,
  defense: 0,
  technologies: [],
  interceptors: 0,
  testsRun: 0,
  testsSuccessful: 0,
  currentDecision: null,
  gameStarted: false,

  // --- NEW: R&D budgets & typed pools ---
  rd: {
    budgetPerMonthB: 0.6,                  // player-controlled in UI
    alloc: { boost:25, midcourse:25, terminal:25, sensor:25 }, // percentages (should sum 100)
    pools: { boost:0, midcourse:0, terminal:0, sensor:0 }      // typed RP pools
  }
};

// Technology Database (from FRUS documents)
let technologies = [
  { id:'hoe',      name:'Homing Overlay Experiment (HOE)', description:'Kinetic energy interceptor system', cost:0.5, researchCost:100, defenseBonus:10, type:'midcourse' },
  { id:'miracl',   name:'MIRACL Chemical Laser',           description:'Mid-Infrared Advanced Chemical Laser', cost:1.2, researchCost:200, defenseBonus:15, type:'boost' },
  { id:'eris',     name:'ERIS System',                     description:'Exoatmospheric Reentry-vehicle Interceptor', cost:0.8, researchCost:150, defenseBonus:12, type:'terminal' },
  { id:'sbi',      name:'Space-Based Interceptors',        description:'Orbital kinetic kill vehicles', cost:3.0, researchCost:500, defenseBonus:25, type:'boost' },
  { id:'bsts',     name:'Boost Surveillance & Tracking',   description:'Early warning satellite constellation', cost:1.5, researchCost:250, defenseBonus:20, type:'sensor' },
  { id:'brilliant',name:'Brilliant Pebbles',               description:'Autonomous orbital interceptors', cost:2.5, researchCost:400, defenseBonus:30, type:'midcourse' },
  { id:'xray',     name:'X-Ray Laser (Excalibur)',         description:'Nuclear-pumped directed energy', cost:5.0, researchCost:800, defenseBonus:40, type:'boost' },
  { id:'neutral',  name:'Neutral Particle Beam',           description:'Discrimination and kill assessment', cost:2.0, researchCost:350, defenseBonus:18, type:'midcourse' }
];

// Historical Decision Points (from FRUS) — unchanged here
const decisions = [
  {
    id:'treaty84',
    year:1984,
    title:'NSC Meeting: ABM Treaty Interpretation',
    text:'The Legal Adviser and Defense Department present conflicting interpretations of ABM Treaty constraints. DoD argues for "broad interpretation" permitting development and testing of space-based systems. State Department warns this could collapse arms control negotiations.',
    options:[
      { text:'Support broad interpretation - Accelerate space-based development', effects:{ political:-20, research:200, defense:10 } },
      { text:'Maintain traditional interpretation - Preserve diplomatic options', effects:{ political:10, research:50, defense:5 } }
    ]
  },
  {
    id:'congress85',
    year:1985,
    title:'Congressional Budget Resolution',
    text:'House Armed Services Committee proposes 40% reduction in SDI funding. Senator Nunn questions program feasibility. Pentagon requests emergency supplemental appropriation.',
    options:[
      { text:'Mobilize Presidential support for full funding', effects:{ budget: Math.random()>0.5 ? 2 : -1.5, political:-15 } },
      { text:'Accept Committee recommendations', effects:{ budget:-0.8, political:5 } },
      { text:'Trade MX missile program for SDI funding', effects:{ budget:1, political:15, defense:-5 } }
    ]
  },
  {
    id:'reykjavik86',
    year:1986,
    title:'Reykjavik Summit Crisis',
    text:'General Secretary Gorbachev proposes elimination of all ballistic missiles contingent on SDI laboratory restriction for 10 years. President Reagan must respond.',
    options:[
      { text:'Accept laboratory limitations - Historic arms reduction', effects:{ political:25, defense:-20, research:-300 } },
      { text:'Reject Soviet proposal - Preserve SDI development', effects:{ political:-10, defense:15, research:100 } }
    ]
  },
  {
    id:'phase87',
    year:1987,
    title:'Phase I Architecture Decision',
    text:'SDIO presents deployment options to NSC. Space-based architecture offers superior coverage but raises treaty concerns. Ground-based system is treaty-compliant but provides limited defense.',
    options:[
      { text:'Approve space-based architecture', effects:{ defense:20, political:-15, budget:-2 } },
      { text:'Select ground-based deployment', effects:{ defense:10, political:10, budget:-1 } },
      { text:'Defer deployment decision pending further research', effects:{ research:150, political:5, defense:5 } }
    ]
  }
];

// Initialize Game
function startGame() {
  gameState.gameStarted = true;
  document.getElementById('missionScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'block';
  renderTechnologies();
  wireRDPanel();    // <-- NEW: build allocation UI hooks
  updateUI();
  addMessage('SDI Program activated per Presidential directive', 'success');
  addMessage('Initial appropriation: $3.8 billion (FY1985)', '');

  // Start game loops
  setInterval(gameLoop, 1000);
  setInterval(yearlyUpdate, 12000); // Every 12 seconds = 1 year
}

// Build/Hook the R&D allocation panel
function wireRDPanel(){
  const rdMonthly = document.getElementById('rdMonthly');
  const rdMonthlyLabel = document.getElementById('rdMonthlyLabel');
  const allocBoost = document.getElementById('allocBoost');
  const allocMid = document.getElementById('allocMid');
  const allocTerm = document.getElementById('allocTerm');
  const allocSens = document.getElementById('allocSens');
  const btnNormalize = document.getElementById('btnNormalize');
  const btnEven = document.getElementById('btnEven');

  if (!rdMonthly) return; // in case panel is not present

  // Seed from state
  rdMonthly.value = gameState.rd.budgetPerMonthB;
  rdMonthlyLabel.textContent = gameState.rd.budgetPerMonthB.toFixed(1);
  allocBoost.value = gameState.rd.alloc.boost;
  allocMid.value   = gameState.rd.alloc.midcourse;
  allocTerm.value  = gameState.rd.alloc.terminal;
  allocSens.value  = gameState.rd.alloc.sensor;

  rdMonthly.oninput = () => {
    gameState.rd.budgetPerMonthB = parseFloat(rdMonthly.value);
    rdMonthlyLabel.textContent = gameState.rd.budgetPerMonthB.toFixed(1);
  };

  function setAllocFromInputs() {
    const a = {
      boost:    clamp(parseFloat(allocBoost.value)||0, 0, 100),
      midcourse:clamp(parseFloat(allocMid.value)||0,   0, 100),
      terminal: clamp(parseFloat(allocTerm.value)||0,  0, 100),
      sensor:   clamp(parseFloat(allocSens.value)||0,  0, 100)
    };
    const sum = a.boost + a.midcourse + a.terminal + a.sensor;
    gameState.rd.alloc = a;
    const warn = document.getElementById('allocWarn');
    if (sum !== 100) {
      warn.textContent = `Allocation sums to ${sum}%. Click "Normalize" to scale to 100%.`;
    } else {
      warn.textContent = '';
    }
  }

  [allocBoost, allocMid, allocTerm, allocSens].forEach(el => {
    el.onchange = setAllocFromInputs;
    el.oninput  = setAllocFromInputs;
  });

  btnNormalize.onclick = () => {
    let a = gameState.rd.alloc;
    const sum = a.boost + a.midcourse + a.terminal + a.sensor || 1;
    a = {
      boost:    Math.round(a.boost    * 100 / sum),
      midcourse:Math.round(a.midcourse* 100 / sum),
      terminal: Math.round(a.terminal * 100 / sum),
      sensor:   100 - (Math.round(a.boost*100/sum) + Math.round(a.midcourse*100/sum) + Math.round(a.terminal*100/sum))
    };
    gameState.rd.alloc = a;
    allocBoost.value = a.boost;
    allocMid.value   = a.midcourse;
    allocTerm.value  = a.terminal;
    allocSens.value  = a.sensor;
    document.getElementById('allocWarn').textContent = '';
  };

  btnEven.onclick = () => {
    gameState.rd.alloc = { boost:25, midcourse:25, terminal:25, sensor:25 };
    allocBoost.value = 25;
    allocMid.value = 25;
    allocTerm.value = 25;
    allocSens.value = 25;
    document.getElementById('allocWarn').textContent = '';
  };
}

// Render Technology Cards (show typed pools effect in the UI)
function renderTechnologies() {
  const grid = document.getElementById('techGrid');
  grid.innerHTML = '';

  technologies.forEach(tech => {
    const isResearched = gameState.technologies.includes(tech.id);

    // Can we meet research cost using type pool + global?
    const typePool = (gameState.rd.pools[tech.type] || 0);
    const effectiveRP = gameState.research + typePool;
    const canAffordResearch = effectiveRP >= tech.researchCost;
    const canAffordBudget   = gameState.budget >= tech.cost;

    const canAfford = canAffordResearch && canAffordBudget;

    const remainingRP = Math.max(0, tech.researchCost - effectiveRP);

    const card = document.createElement('div');
    card.className = `tech-card ${isResearched ? 'researched' : ''} ${!canAfford && !isResearched ? 'locked' : ''}`;
    card.innerHTML = `
      <div class="tech-name">${tech.name}</div>
      <div class="tech-description">${tech.description}</div>
      <div class="tech-cost">
        ${isResearched
          ? 'STATUS: OPERATIONAL'
          : `Needs: $${tech.cost}B | ${tech.researchCost} RP (shortfall: ${remainingRP} RP)`}
      </div>
      <div style="font-size:0.85em;color:#5c4033;margin-top:6px;">
        Type: ${tech.type.charAt(0).toUpperCase() + tech.type.slice(1)} | Type RP: ${(gameState.rd.pools[tech.type]||0)}
      </div>
    `;

    if (!isResearched && canAfford) {
      card.onclick = () => researchTechnology(tech);
    }

    grid.appendChild(card);
  });
}

// Research Technology (pay from type pool first, then global; budget from Budget Authorization)
function researchTechnology(tech) {
  const type = tech.type;
  const typePool = gameState.rd.pools[type] || 0;
  const globalRP = gameState.research;
  const effectiveRP = typePool + globalRP;

  if (gameState.budget >= tech.cost && effectiveRP >= tech.researchCost) {
    // Deduct RP: type pool first
    let need = tech.researchCost;
    const useType = Math.min(need, typePool);
    gameState.rd.pools[type] = typePool - useType;
    need -= useType;
    if (need > 0) gameState.research = Math.max(0, globalRP - need);

    // Deduct budget dollars
    gameState.budget -= tech.cost;

    // Apply effects
    gameState.technologies.push(tech.id);
    gameState.defense = clamp(gameState.defense + tech.defenseBonus, 0, 100);
    gameState.political = clamp(gameState.political + 5, 0, 100);
    gameState.testsRun++;
    gameState.testsSuccessful++;

    if (tech.type === 'midcourse' || tech.type === 'terminal') {
      gameState.interceptors += Math.floor(tech.defenseBonus / 2);
    }

    addMessage(`${tech.name} deployment authorized and operational`, 'success');
    renderTechnologies();
    updateUI();
  }
}

// Handle Decisions (unchanged)
function triggerDecision(decision) {
  if (gameState.currentDecision) return;
  gameState.currentDecision = decision;
  const panel = document.getElementById('decisionPanel');
  panel.className = 'decision-panel active';
  document.getElementById('decisionTitle').textContent = decision.title;
  document.getElementById('decisionText').textContent = decision.text;

  const optionsDiv = document.getElementById('decisionOptions');
  optionsDiv.innerHTML = '';

  decision.options.forEach((option, index) => {
    const button = document.createElement('button');
    button.className = 'decision-button';
    button.textContent = option.text;
    button.onclick = () => makeDecision(index);
    optionsDiv.appendChild(button);
  });

  addMessage(`PRIORITY: ${decision.title}`, 'critical');
}

function makeDecision(optionIndex) {
  const decision = gameState.currentDecision;
  const option = decision.options[optionIndex];

  Object.keys(option.effects).forEach(key => {
    if (key === 'budget') {
      gameState[key] = Math.max(0, Math.min(gameState.maxBudget, gameState[key] + option.effects[key]));
    } else if (key === 'research') {
      gameState[key] = Math.max(0, Math.min(gameState.maxResearch, gameState[key] + option.effects[key]));
    } else {
      gameState[key] = Math.max(0, Math.min(100, gameState[key] + option.effects[key]));
    }
  });

  addMessage(`Decision recorded: ${decision.title}`, 'warning');
  document.getElementById('decisionPanel').className = 'decision-panel';
  gameState.currentDecision = null;
  updateUI();
}

// Missile Defense Simulation (unchanged)
function simulateMissileAttack(missileCount) {
  addMessage(`FLASH PRIORITY: ${missileCount} Soviet ICBMs detected by NORAD`, 'critical');
  document.getElementById('threatIndicator').className = 'threat-indicator active';
  document.getElementById('missileCount').textContent = missileCount;

  const defenseScreen = document.getElementById('defenseScreen');
  defenseScreen.className = 'defense-screen active';
  document.getElementById('gameScreen').style.display = 'none';

  gameState.testsRun++;
  let missilesDestroyed = 0;
  const interceptionRate = Math.min(0.9, gameState.defense / 100);

  for (let i = 0; i < missileCount; i++) {
    if (Math.random() < interceptionRate) missilesDestroyed++;
  }
  if (missilesDestroyed > 0) gameState.testsSuccessful++;

  setTimeout(() => {
    const survived = missileCount - missilesDestroyed;
    if (survived === 0) {
      addMessage(`DEFENSE SUCCESS: All ${missileCount} targets neutralized`, 'success');
      gameState.political = Math.min(100, gameState.political + 20);
    } else if (survived < missileCount / 2) {
      addMessage(`PARTIAL SUCCESS: ${missilesDestroyed}/${missileCount} intercepted, ${survived} leaked through`, 'warning');
      gameState.political = clamp(gameState.political + 5, 0, 100);
    } else {
      addMessage(`DEFENSE FAILURE: Only ${missilesDestroyed}/${missileCount} intercepted`, 'critical');
      gameState.political = Math.max(0, gameState.political - 20);
    }

    document.getElementById('threatIndicator').className = 'threat-indicator';
    defenseScreen.className = 'defense-screen';
    document.getElementById('gameScreen').style.display = 'block';
    updateUI();
  }, 5000);
}

// -------------------- R&D ENGINE --------------------
function rdMonthlyTick() {
  // Spend the declared monthly R&D budget, capped by available funds
  const wantB = gameState.rd.budgetPerMonthB;
  const canB  = Math.min(wantB, gameState.budget);
  if (canB <= 0) return;

  // Deduct money, convert to RP
  gameState.budget -= canB;
  const totalRP = Math.round(canB * RP_PER_BILLION);

  // Normalize/scale allocations to 100%
  const a = gameState.rd.alloc;
  let sum = a.boost + a.midcourse + a.terminal + a.sensor;
  if (sum <= 0) sum = 1;
  const f = { boost: a.boost/sum, midcourse: a.midcourse/sum, terminal: a.terminal/sum, sensor: a.sensor/sum };

  // Distribute RP into type pools
  gameState.rd.pools.boost     += Math.round(totalRP * f.boost);
  gameState.rd.pools.midcourse += Math.round(totalRP * f.midcourse);
  gameState.rd.pools.terminal  += Math.round(totalRP * f.terminal);
  gameState.rd.pools.sensor    += Math.round(totalRP * f.sensor);

  addMessage(`R&D executed: $${canB.toFixed(1)}B → ${totalRP} RP (Boost/Mid/Term/Sens)`, '');
  updateRDPoolUI();
  renderTechnologies();
}

// Helper to update the little pool labels in the panel
function updateRDPoolUI(){
  const byId = id => document.getElementById(id);
  const P = gameState.rd.pools;
  if (byId('rpBoost')) byId('rpBoost').textContent = Math.round(P.boost);
  if (byId('rpMid'))   byId('rpMid').textContent   = Math.round(P.midcourse);
  if (byId('rpTerm'))  byId('rpTerm').textContent  = Math.round(P.terminal);
  if (byId('rpSens'))  byId('rpSens').textContent  = Math.round(P.sensor);
}

// Game Loop
function gameLoop() {
  if (!gameState.gameStarted) return;

  // Keep your original passive research drip (scaled by # of techs)
  gameState.research = Math.min(gameState.maxResearch, gameState.research + gameState.technologies.length * 2);

  // Random threat events
  if (Math.random() < 0.001) {
    const missileCount = Math.floor(Math.random() * 10) + 1;
    simulateMissileAttack(missileCount);
  }

  updateUI();
}

// Yearly Update (unchanged, except UI refresh)
function yearlyUpdate() {
  if (!gameState.gameStarted) return;

  gameState.year++;
  gameState.budget = Math.min(gameState.maxBudget, gameState.budget + 2);

  addMessage(`FY${gameState.year} Congressional appropriation received`, '');

  // Historical decisions
  const yearDecision = decisions.find(d => d.year === gameState.year);
  if (yearDecision) triggerDecision(yearDecision);

  // Random Congressional actions
  if (Math.random() < 0.3 && !gameState.currentDecision) {
    const budgetChange = (Math.random() - 0.5) * 1.5;
    gameState.budget = Math.max(0.5, Math.min(gameState.maxBudget, gameState.budget + budgetChange));
    if (budgetChange > 0) addMessage(`Congress approves $${Math.abs(budgetChange).toFixed(1)}B supplemental`, 'success');
    else addMessage(`Budget reduction: $${Math.abs(budgetChange).toFixed(1)}B`, 'warning');
  }

  // *** NEW: do the monthly R&D spend 12x a year ***
  for (let i = 0; i < 12; i++) rdMonthlyTick();

  // Victory/defeat
  if (gameState.year >= 1993) {
    if (gameState.defense >= 50) {
      alert('MISSION ACCOMPLISHED\n\nYou successfully developed and deployed the Strategic Defense Initiative.\n\nFinal Defense Capability: ' + gameState.defense + '%\nTechnologies Deployed: ' + gameState.technologies.length);
    } else {
      alert('PROGRAM TERMINATED\n\nSDI failed to achieve minimum viable defense capability.\n\nFinal Defense Capability: ' + gameState.defense + '%');
    }
    location.reload();
  }

  updateUI();
}

// Update UI
function updateUI() {
  document.getElementById('budget').textContent = `$${gameState.budget.toFixed(1)}B`;
  document.getElementById('budgetBar').style.width = `${(gameState.budget / gameState.maxBudget) * 100}%`;

  document.getElementById('research').textContent = gameState.research;
  document.getElementById('researchBar').style.width = `${(gameState.research / gameState.maxResearch) * 100}%`;

  document.getElementById('political').textContent = `${gameState.political}%`;
  document.getElementById('politicalBar').style.width = `${gameState.political}%`;

  document.getElementById('defense').textContent = `${gameState.defense}%`;
  document.getElementById('defenseBar').style.width = `${gameState.defense}%`;

  document.getElementById('currentYear').textContent = gameState.year;
  document.getElementById('techCount').textContent = gameState.technologies.length;
  document.getElementById('interceptorCount').textContent = gameState.interceptors;

  const successRate = gameState.testsRun > 0 
    ? Math.round((gameState.testsSuccessful / gameState.testsRun) * 100) + '%'
    : 'N/A';
  document.getElementById('successRate').textContent = successRate;

  updateRDPoolUI();
}

// Message System (unchanged)
function addMessage(text, type = '') {
  const log = document.getElementById('messageLog');
  const message = document.createElement('div');
  message.className = `message ${type}`;
  const date = new Date();
  const timestamp = `${date.getMonth() + 1}/${date.getDate()}/${gameState.year}`;
  message.textContent = `[${timestamp}] ${text}`;
  log.insertBefore(message, log.firstChild);

  while (log.children.length > 8) {
    log.removeChild(log.lastChild);
  }
}

// Utility
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
</script>





    


    <script>
/* ===================== NSA DESK + FRUS MONTHLY ENGINE (1985–1988) =====================
   Drop-in replacement for:
     1) FRUS TEI → Monthly SDI Decisions script
     2) Immediate Jan 1985 Decision script

   Requires your base gameplay script (gameState, renderTechnologies, triggerDecision, updateUI, addMessage)
   to be loaded BEFORE this block.

   What this adds:
   - Monthly clock from Jan 1985 → Dec 1988 (6s/month)
   - FRUS TEI XML loader (raw.githubusercontent.com first, with fallbacks)
   - FRUS badge in sidebar header (auto toggled)
   - NSA Desk pane (shows primary-source FRUS excerpt + actions)
   - Expanded choices: ABM interpretations, SDI, Reykjavik contingencies, MX basing, congressional dynamics
   - Uses ONLY content parsed from the FRUS XML to seed decisions (plus small chance modifiers)
======================================================================================== */

(function(){
  /* -------------------- Config & Utilities -------------------- */
  const TICK_MS = 6000; // 6 seconds = 1 month
  const START = { y: 1985, m: 1 };
  const END   = { y: 1988, m: 12 };
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  // Ensure month field exists and override yearly loop
  gameState.year = START.y;
  gameState.month = START.m;

  if (typeof window.yearlyUpdate === 'function') { window.yearlyUpdate = function(){}; }
  if (!document.getElementById('currentMonthRow')) {
    const stats = document.querySelector('.stats-panel');
    if (stats) {
      const row = document.createElement('div');
      row.className = 'stat-item';
      row.id = 'currentMonthRow';
      row.innerHTML = '<span class="stat-label">Month:</span><span class="stat-value" id="currentMonth">1</span>';
      stats.insertBefore(row, stats.children[1]);
    }
  }

  // clamp helpers
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const yyyymm = (y,m)=> y*100 + m;
  const inRange = (y,m)=> yyyymm(y,m)>=yyyymm(START.y,START.m) && yyyymm(y,m)<=yyyymm(END.y,END.m);
  function nextMonth(y,m){ m++; if(m>12){m=1;y++;} return {y,m}; }

  // Improve timestamps to show current game month/year
  const _origAddMessage = window.addMessage;
  window.addMessage = function(text, type='') {
    const log = document.getElementById('messageLog');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    const date = new Date();
    const ts = `${monthNames[(gameState.month||1)-1].slice(0,3)} ${date.getDate()}, ${gameState.year}`;
    message.textContent = `[${ts}] ${text}`;
    log.insertBefore(message, log.firstChild);
    while (log.children.length > 8) log.removeChild(log.lastChild);
  };

  const _origUpdateUI = window.updateUI;
  window.updateUI = function(){
    _origUpdateUI();
    const m = document.getElementById('currentMonth');
    if (m) m.textContent = gameState.month;
  };

  /* -------------------- FRUS Badge (auto toggled) -------------------- */
  function ensureBadgeCSS(){
    if (document.getElementById('badgeStyles')) return;
    const style = document.createElement('style');
    style.id = 'badgeStyles';
    style.textContent = `
      .badge{display:inline-block;margin-left:8px;padding:2px 10px;font-size:.75em;font-weight:700;border-radius:12px;border:1px solid #4a7c59;background:#4a7c59;color:#fff;vertical-align:middle;letter-spacing:.5px}
      .badge.off{border-color:#8a8a8a;background:#8a8a8a}
      .nsa-desk{background:#fff;border:2px solid #8b3a21;box-shadow:0 2px 8px rgba(0,0,0,.12);padding:16px;margin-top:16px}
      .nsa-desk h4{color:#8b3a21;margin-bottom:10px}
      .nsa-doc{background:#faf8f3;border-left:3px solid #8b3a21;padding:12px;margin:10px 0;max-height:220px;overflow:auto}
      .nsa-actions{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
      .nsa-secondary{font-size:.85em;color:#5c4033;margin-top:8px}
      .nsa-small{font-size:.85em;opacity:.8}
      .nsa-inline{display:inline-block;margin-left:8px}
      .nsa-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    `;
    document.head.appendChild(style);
  }
  ensureBadgeCSS();

  // If the header <h3> doesn’t yet include the badge, inject it
  (function ensureBadgeHost(){
    const hdr = Array.from(document.querySelectorAll('.sidebar h3')).find(h=>/PROGRAM STATUS/i.test(h.textContent));
    if (hdr && !document.getElementById('frusBadge')) {
      const span = document.createElement('span');
      span.id = 'frusBadge';
      span.className = 'badge off';
      span.textContent = 'FRUS FALLBACK';
      span.title = 'FRUS XML not loaded';
      hdr.appendChild(span);
    }
  })();

  function setFrusBadge(active, info){
    const el = document.getElementById('frusBadge');
    if (!el) return;
    if (active) {
      el.classList.remove('off');
      el.textContent = 'FRUS-DRIVEN SCENARIO';
      el.title = info || 'Decisions sourced from FRUS TEI XML';
    } else {
      el.classList.add('off');
      el.textContent = 'FRUS FALLBACK';
      el.title = 'Running without FRUS XML (base gameplay events)';
    }
  }
  window.setFrusBadge = setFrusBadge;

  /* -------------------- NSA Desk Pane (UI) -------------------- */
  function ensureNSADesk(){
    if (document.getElementById('nsaDesk')) return;

    const mainPanel = document.querySelector('.main-panel');
    const desk = document.createElement('div');
    desk.id = 'nsaDesk';
    desk.className = 'nsa-desk';
    desk.innerHTML = `
      <h4>National Security Advisor Desk <span class="nsa-small nsa-inline" id="nsaDate"></span></h4>
      <div class="nsa-secondary">Incoming FRUS brief (excerpt from the period record):</div>
      <div class="nsa-doc" id="nsaDoc">No FRUS brief this month (fallback mode or no doc).</div>
      <div class="nsa-secondary nsa-row">
        <span id="nsaSource" class="nsa-small"></span>
      </div>
      <div class="nsa-actions" id="nsaActions"></div>
    `;
    // Place the desk right above the decision panel (if present) or at the bottom of main panel
    const decisionPanel = document.getElementById('decisionPanel');
    if (decisionPanel) mainPanel.insertBefore(desk, decisionPanel);
    else mainPanel.appendChild(desk);
  }
  ensureNSADesk();

  function setNSABrief({title, quote, link, when}){
    const doc = document.getElementById('nsaDoc');
    const src = document.getElementById('nsaSource');
    const dt  = document.getElementById('nsaDate');
    if (!doc || !src || !dt) return;

    dt.textContent = when ? `— ${when}` : '';
    doc.textContent = quote || 'No FRUS brief available.';
    src.innerHTML = title ? `<strong>Doc:</strong> ${title}${link?` &middot; <a href="${link}" target="_blank">FRUS Source</a>`:''}` : '';
  }

  function setNSAOptions(options){
    const box = document.getElementById('nsaActions');
    if (!box) return;
    box.innerHTML = '';
    (options || []).forEach((opt,i)=>{
      const b = document.createElement('button');
      b.className = 'decision-button';
      b.textContent = opt.text;
      b.onclick = ()=> opt.onchoose && opt.onchoose();
      box.appendChild(b);
    });
  }

  /* -------------------- FRUS TEI Loader & Index -------------------- */
  let _tei = null;
  let _decisionsByMonth = new Map();
  window._decisionsByMonth = _decisionsByMonth; // expose for debugging

  (async function loadFRUS(){
    const origin = location.origin;
    const basePath = location.pathname.replace(/[^/]+$/, '');
    const candidates = [
      'https://raw.githubusercontent.com/therealjameswilson/SDI_Commander/main/frus1981-88v44p1.xml', // best bet
      basePath + 'frus1981-88v44p1.xml',
      basePath + 'data/frus1981-88v44p1.xml',
      basePath + 'volumes/frus1981-88v44p1.xml',
      origin + '/SDI_Commander/frus1981-88v44p1.xml',
      origin + '/SDI_Commander/data/frus1981-88v44p1.xml',
      origin + '/SDI_Commander/volumes/frus1981-88v44p1.xml'
    ];

    let lastURL=null,lastStatus='';
    for (const url of candidates) {
      try {
        lastURL = url;
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) { lastStatus = ` [${res.status} ${res.statusText||''}]`; continue; }
        const txt = await res.text();
        if (txt.includes('<html') && !/<TEI[\s>]/i.test(txt)) continue;
        _tei = new DOMParser().parseFromString(txt, 'text/xml');
        if (!_tei.querySelector('TEI, tei\\:TEI')) continue;
        indexFRUS();
        // Badge on
        let docs=0; for(const arr of _decisionsByMonth.values()) docs += (arr?.length||0);
        setFrusBadge(true, `${docs} FRUS docs across ${_decisionsByMonth.size} months`);
        addMessage('FRUS XML loaded. Monthly NSA briefs enabled.', 'success');
        return;
      } catch(e){ /* try next */ }
    }
    // Fallback
    setFrusBadge(false);
    addMessage(`FRUS XML not found — running base gameplay only. Last tried: ${lastURL||''}${lastStatus}`, 'warning');
  })();

  function indexFRUS(){
    const $ = (n,s)=> Array.from(n.querySelectorAll(s));
    const T = (n)=> (n ? n.textContent.replace(/\s+/g,' ').trim() : '');
    const DATE = /\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},\s+(19\d{2})\b/;
    const MONEY = /\$?\s*(\d+(?:\.\d+)?)\s*(billion|bn|b|million|m)\b/ig;

    // Likely doc containers
    const docNodes = _tei.querySelectorAll('div[type="document"], div[type="doc"], div.doc, div.document, div[xml\\:id]');
    const nodes = docNodes.length ? Array.from(docNodes) : Array.from(_tei.querySelectorAll('div'));

    const KEYS = [
      /Strategic Defense Initiative|SDI\b/i,
      /\bABM\b|anti-?ballistic|treaty interpretation|broad interpretation|laboratory/i,
      /Reykjav[ií]k|H[oö]fði/i,
      /Phase\s*I|deployment|architecture|IOC/i,
      /Congress|Senate|House|Appropriations|Authorization|Budget|Markup|HASC|SASC|Nunn|Aspin|Proxmire/i,
      /\bSDIO\b|HOE\b|MIRACL|ERIS\b|Brilliant Pebbles|Neutral Particle Beam|Excalibur|X-?Ray/i,
      /\bJCS\b|Joint Chiefs|Air Force|Army|Navy|OSD|DOD|Secretary of Defense|Weinberger|Carlucci/i,
      /\bMX\b|Peacekeeper|basing|dense pack|rail garrison/i
    ];

    const items = nodes
      .filter(d => KEYS.some(re => re.test(T(d).slice(0,200000))))
      .map(d => {
        const id = d.getAttribute('xml:id') || d.getAttribute('id') || '';
        const head = d.querySelector('head') || d.querySelector('p.head') || d.querySelector('p.title');
        const title = head ? T(head) : (T(d).match(/^([A-Z0-9].{0,120}?)([.:—])/ )||['','(Untitled)'])[1];
        const dl = d.querySelector('dateline, p.dateline, note.dateline') || d;
        const m = T(dl).match(DATE);
        let year=null, month=null;
        if (m){ year=+m[2]; month = monthNames.indexOf(m[1]) + 1; }

        const full = T(d);

        // collect $B figures (normalize to billions)
        const money=[]; let mm;
        while((mm = MONEY.exec(full))){
          let v = parseFloat(mm[1]); const unit=(mm[2]||'').toLowerCase();
          v = unit.startsWith('b') ? v : v/1000;
          money.push(v);
        }

        const isABM = /\babm\b|anti-?ballistic|treaty interpretation|broad interpretation|laboratory/i.test(full);
        const isReyk= /reykjav|höfði|hofdi/i.test(full);
        const isBudget=/appropriation|authorization|budget|committee|markup|supplemental|reduce|cut|increase/i.test(full);
        const isService=/\bJCS\b|Joint Chiefs|Air Force|Army|Navy|OSD|DOD|service chief|Chairman\b/i.test(full);
        const isTech=/HOE\b|MIRACL|ERIS\b|Brilliant Pebbles|Neutral Particle Beam|Excalibur|X-?Ray|boost|midcourse|terminal|discrimination|sensor/i.test(full);
        const isMX=/\bMX\b|Peacekeeper|dense pack|rail garrison|basing/i.test(full);

        // choose an excerpt paragraph
        let quote = '';
        for (const p of d.querySelectorAll('p')) {
          const tp = T(p);
          if (tp.length > 120 && /(missile|defense|treaty|test|space|congress|budget|summit|proposal|interpretation|basing|mx|peacekeeper)/i.test(tp)) {
            quote = tp.slice(0, 600) + (tp.length>600 ? '…' : '');
            break;
          }
        }
        if (!quote) quote = full.slice(0, 500);

        return { id, title, year, month, full, money, isABM, isReyk, isBudget, isService, isTech, isMX, quote };
      })
      .filter(x => x.year && x.month && inRange(x.year, x.month));

    _decisionsByMonth = new Map();
    for (const it of items) {
      const key = `${it.year}-${String(it.month).padStart(2,'0')}`;
      if (!_decisionsByMonth.has(key)) _decisionsByMonth.set(key, []);
      _decisionsByMonth.get(key).push(it);
    }
    window._decisionsByMonth = _decisionsByMonth; // refresh exposed ref
  }

  /* -------------------- Decision Builder (NSA choices) -------------------- */
  function buildDecision(it){
    // Infer budget delta from $ values + verb cues
    let budgetDelta = 0;
    if (it.money.length){
      const sorted = it.money.slice().sort((a,b)=>a-b);
      const med = sorted[Math.floor(sorted.length/2)];
      const cut = /\b(cut|reduce|reduction|freeze|cap|defer)\b/i.test(it.full);
      const plus= /\b(appropriate|authorize|increase|supplemental|approve|pass|fund)\b/i.test(it.full);
      budgetDelta = cut ? -med : (plus ? +med : 0);
      budgetDelta = clamp(budgetDelta, -3.0, 3.0);
    }

    let pol = 0, def = 0, rp = 0;
    if (it.isBudget){ if (/\b(cut|reduce|freeze)\b/i.test(it.full)) pol -= 12; if (/\b(approve|support|authorize|pass|reaffirm)\b/i.test(it.full)) pol += 10; }
    if (it.isService){ if (/\bconcern|skeptic|immature|not feasible|risk|viability\b/i.test(it.full)) pol -= 6; if (/\bsupport|endorse|advocate|deployment|IOC\b/i.test(it.full)) pol += 5; }
    if (it.isTech){ rp += 100; def += 6; }
    if (/\btest|trial|demo|HOE|MIRACL|ERIS|Pebbles|beam|laser|particle|x-ray\b/i.test(it.full)){ rp += 60; def += 4; }
    if (it.isABM){ rp += 40; def += 4; }
    if (it.isReyk){ rp += 30; def += (/\blab(?:oratory)? (?:only|limits|restriction)\b/i.test(it.full)) ? -8 : 8; }
    rp = clamp(rp, -300, 300);
    def = clamp(def, -20, 20);

    const srcHash = it.id ? `#${it.id}` : '';
    const when = `${monthNames[it.month-1]} ${it.year}`;

    // Core options (NSA framing)
    const options = [];

    if (it.isABM){
      options.push(
        { label: 'Side with DoD: Broad ABM interpretation → enable space testing',
          eff: { political: pol-6, research: rp+90, defense: def+6, budget: budgetDelta } },
        { label: 'Side with State: Traditional interpretation to protect talks',
          eff: { political: pol+8, research: rp+20, defense: def+2, budget: Math.min(0,budgetDelta) } },
        { label: 'Brief the President: present split memo; seek guidance',
          eff: { political: pol+2, research: rp+35, defense: def+3 } }
      );
    }

    if (it.isBudget){
      options.push(
        { label: 'Hill push: mobilize WH for full authorization/appropriation',
          eff: { political: pol-10, budget: Math.max(0.6, Math.abs(budgetDelta)||1.0) } },
        { label: 'Accept trims to stabilize coalition',
          eff: { political: pol+8, budget: -Math.max(0.4, Math.abs(budgetDelta)/2 || 0.6) } }
      );
    }

    if (it.isReyk){
      options.push(
        { label: 'Advise go to Reykjavik, accept lab-only SDI limits for reductions',
          eff: { political: pol+15, research: rp-120, defense: def-10 } },
        { label: 'Advise go, but reject SDI limits; preserve full scope',
          eff: { political: pol-8, research: rp+60, defense: def+8 } },
        { label: 'Recommend not to go (contingency path)',
          eff: { political: pol-6, research: rp+10, defense: def+2, meta:'noReyk' } }
      );
    }

    if (it.isMX){
      // MX/Peacekeeper basing tradeoffs grounded in FRUS: dense pack vs rail vs silo upgrades
      options.push(
        { label: 'Back MX “Dense Pack” concept (concentrated silos)',
          eff: { political: -8, budget: +0.8, defense: +6, research: +20 } },
        { label: 'Support “Rail Garrison” mobile basing',
          eff: { political: +6, budget: +1.2, defense: +8, research: +30 } },
        { label: 'Defer basing; keep limited procurement',
          eff: { political: +4, budget: -0.4, defense: +2, research: +10 } }
      );
    }

    // Generic SDI-forward vs Arms-control-forward fallback
    if (!options.length){
      options.push(
        { label: 'SDI-forward course',
          eff: { political: pol-4, research: rp+40, defense: def+4, budget: Math.max(0,budgetDelta) } },
        { label: 'Arms-control-forward course',
          eff: { political: pol+6, research: rp+20, defense: def+2, budget: Math.min(0,budgetDelta) } }
      );
    }

    // Convert to NSA action buttons with luck factor
    const nsaOptions = options.map(o => ({
      text: o.label,
      onchoose: ()=>{
        const jitter = ()=> (Math.random() - 0.5); // small chance noise
        const eff = Object.assign({}, o.eff);
        // apply effects
        for (const k of Object.keys(eff)){
          if (k==='budget'){
            gameState.budget = clamp(gameState.budget + eff[k], 0, gameState.maxBudget);
          } else if (k==='research'){
            gameState.research = clamp(gameState.research + eff[k] + Math.round(10*jitter()), 0, gameState.maxResearch);
          } else if (k==='defense'){
            gameState.defense = clamp(gameState.defense + eff[k] + Math.round(2*jitter()), 0, 100);
          } else if (k==='political'){
            gameState.political = clamp(gameState.political + eff[k] + Math.round(2*jitter()), 0, 100);
          } else if (k==='meta' && eff[k]==='noReyk'){
            // contingency flag for later branches
            gameState.noReyk = true;
          }
        }
        addMessage(`NSA action taken: ${o.label}`, 'warning');
        updateUI();
      }
    }));

    // Return a structure for both NSA Desk and classic decision panel
    return {
      when,
      nsa: {
        title: it.title,
        quote: it.quote,
        link: it.id ? (`frus1981-88v44p1.html#${it.id}`) : '',
        options: nsaOptions
      },
      // Optional: classic panel if you still want to pop it
      panel: {
        id: (it.id || (it.title.replace(/\W+/g,'_') + '_' + it.year)).toLowerCase(),
        title: `${it.title} — ${when}`,
        text: `${it.quote}\n\nSource: ${it.id?('#'+it.id):'(local TEI document)'}`
      }
    };
  }

  /* -------------------- Monthly Timer -------------------- */
  function wireMonthlyTimer(){
    if (window._monthTimer) clearInterval(window._monthTimer);
    window._monthTimer = setInterval(monthlyTick, TICK_MS);
  }
  wireMonthlyTimer();

  function monthlyTick(){
    if (!gameState.gameStarted) return;

    // advance month
    const nm = nextMonth(gameState.year, gameState.month);
    gameState.year = nm.y;
    gameState.month = nm.m;

    // monthly budget trickle (about +0.18B/month ~= +2B/year)
    gameState.budget = clamp(gameState.budget + 0.18, 0, gameState.maxBudget);
    addMessage(`Monthly update: ${monthNames[gameState.month-1]} ${gameState.year}.`, '');

    // If FRUS docs indexed for this month, show NSA brief
    const key = `${gameState.year}-${String(gameState.month).padStart(2,'0')}`;
    const docs = (_decisionsByMonth && _decisionsByMonth.get(key)) || [];
    if (docs.length){
      // weight ABM > Congress/Reyk > Service > Tech > MX to pick the top doc
      const w = (x)=> (x.isABM?5:0)+(x.isBudget?4:0)+(x.isReyk?4:0)+(x.isService?3:0)+(x.isMX?3:0)+(x.isTech?2:0);
      const top = docs.slice().sort((a,b)=>w(b)-w(a))[0];
      const built = buildDecision(top);

      // NSA desk
      setNSABrief({ title: built.nsa.title, quote: built.nsa.quote, link: built.nsa.link, when: built.when });
      setNSAOptions(built.nsa.options);

      // Optional: if you also want to light up the classic decision panel:
      triggerDecision({
        id: built.panel.id,
        year: gameState.year,
        title: built.panel.title,
        text: built.panel.text,
        options: built.nsa.options.map(o=>({ text:o.text, effects:{} , _on:o.onchoose }))
      });

      // Hook classic decision buttons to NSA effects
      const btns = document.querySelectorAll('#decisionOptions .decision-button');
      btns.forEach((b, i)=>{
        const handler = built.nsa.options[i] && built.nsa.options[i].onchoose;
        if (handler) b.onclick = ()=>{ handler(); document.getElementById('decisionPanel').className='decision-panel'; gameState.currentDecision=null; };
      });

      // Reykjavik contingency follow-on
      if (top.isReyk && gameState.noReyk){
        addMessage('Contingency in effect: NSA advised against Reykjavik; arms-control track cools temporarily.', 'warning');
        gameState.political = clamp(gameState.political - 5, 0, 100);
        gameState.research  = clamp(gameState.research + 20, 0, gameState.maxResearch);
      }
    } else {
      // No doc this month; clear NSA actions but keep panel
      setNSABrief({ title:'', quote:'No FRUS brief this month (no indexed doc).', link:'', when:`${monthNames[gameState.month-1]} ${gameState.year}` });
      setNSAOptions([]);
    }

    // Install: if FRUS-derived technologies were built elsewhere, we could swap here
    // (Keeping your current tech list for stability.)

    updateUI();

    // scenario end
    if (!inRange(gameState.year, gameState.month)){
      clearInterval(window._monthTimer);
      if (gameState.defense >= 50) {
        alert('MISSION ACCOMPLISHED\n\nYou successfully managed the NSC process and SDI trajectory.\n\nFinal Defense Capability: ' + gameState.defense + '%\nTechnologies Deployed: ' + gameState.technologies.length);
      } else {
        alert('PROGRAM TERMINATED\n\nDefense capability fell short.\n\nFinal Defense Capability: ' + gameState.defense + '%');
      }
    }
  }

  /* -------------------- Start-game hook: immediate monthly brief if ready -------------------- */
  if (typeof window.startGame === 'function'){
    const _origStart = window.startGame;
    window.startGame = function(){
      _origStart();
      // fire one synthetic tick to show the first month's brief immediately
      // (without advancing the calendar twice)
      const key = `${gameState.year}-${String(gameState.month).padStart(2,'0')}`;
      if (_decisionsByMonth && _decisionsByMonth.get(key)){
        // simulate just the UI portion of monthlyTick
        addMessage(`Monthly update: ${monthNames[gameState.month-1]} ${gameState.year}.`, '');
        const docs = _decisionsByMonth.get(key) || [];
        if (docs.length){
          const w = (x)=> (x.isABM?5:0)+(x.isBudget?4:0)+(x.isReyk?4:0)+(x.isService?3:0)+(x.isMX?3:0)+(x.isTech?2:0);
          const top = docs.slice().sort((a,b)=>w(b)-w(a))[0];
          const built = buildDecision(top);
          setNSABrief({ title: built.nsa.title, quote: built.nsa.quote, link: built.nsa.link, when: built.when });
          setNSAOptions(built.nsa.options);
          triggerDecision({
            id: built.panel.id,
            year: gameState.year,
            title: built.panel.title,
            text: built.panel.text,
            options: built.nsa.options.map(o=>({ text:o.text, effects:{}, _on:o.onchoose }))
          });
          const btns = document.querySelectorAll('#decisionOptions .decision-button');
          btns.forEach((b, i)=>{
            const handler = built.nsa.options[i] && built.nsa.options[i].onchoose;
            if (handler) b.onclick = ()=>{ handler(); document.getElementById('decisionPanel').className='decision-panel'; gameState.currentDecision=null; };
          });
          updateUI();
        }
      }
    };
  }

})();
</script>
<script>
// ================== FRUS-MONTH DECISION BRIDGE ==================
// Requirements: your TEI loader built _decisionsByMonth (Map) and buildDecision(it)
// If TEI isn't loaded, we fall back to "no decision this month" without adding fake ones.

// --- Config ---
const MONTH_TICK_MS = 6000; // 1 month = 6s (tune as you like)
const START_MONTH = 1;      // January
const END_FRAME = { y: 1988, m: 12 }; // end of scenario

// --- Ensure month exists on gameState and show in stats once ---
(function ensureMonthUI(){
  if (typeof gameState.month !== 'number') gameState.month = START_MONTH;
  const stats = document.querySelector('.stats-panel');
  if (stats && !document.getElementById('currentMonthRow')) {
    const row = document.createElement('div');
    row.className = 'stat-item';
    row.id = 'currentMonthRow';
    row.innerHTML = '<span class="stat-label">Month:</span><span class="stat-value" id="currentMonth">'+gameState.month+'</span>';
    stats.insertBefore(row, stats.children[1]);
  }
  // Patch updateUI to keep Month refreshed
  const _u = window.updateUI;
  window.updateUI = function(){
    _u();
    const m = document.getElementById('currentMonth');
    if (m) m.textContent = gameState.month;
  };
})();

// --- Turn off yearly "canned" decisions ---
(function neuterYearlyDecisions(){
  // Keep your budget/year mechanics, but do NOT insert decisions here
  const _yearly = window.yearlyUpdate;
  window.yearlyUpdate = function(){
    if (!gameState.gameStarted) return;
    // Advance fiscal year and add appropriation exactly like before
    gameState.year++;
    gameState.budget = Math.min(gameState.maxBudget, gameState.budget + 2);
    addMessage(`FY${gameState.year} Congressional appropriation received`, '');

    // Optional: keep random budget drift
    if (Math.random() < 0.3 && !gameState.currentDecision) {
      const budgetChange = (Math.random() - 0.5) * 1.5;
      gameState.budget = Math.max(0.5, Math.min(gameState.maxBudget, gameState.budget + budgetChange));
      if (budgetChange > 0) addMessage(`Congress approves $${Math.abs(budgetChange).toFixed(1)}B supplemental`, 'success');
      else addMessage(`Budget reduction: $${Math.abs(budgetChange).toFixed(1)}B`, 'warning');
    }

    // *** DO NOT: trigger canned decisions here ***
    // Victory check stays the same
    if (gameState.year >= 1993) {
      if (gameState.defense >= 50) {
        alert('MISSION ACCOMPLISHED\n\nYou successfully developed and deployed the Strategic Defense Initiative.\n\nFinal Defense Capability: ' + gameState.defense + '%\nTechnologies Deployed: ' + gameState.technologies.length);
      } else {
        alert('PROGRAM TERMINATED\n\nSDI failed to achieve minimum viable defense capability.\n\nFinal Defense Capability: ' + gameState.defense + '%');
      }
      location.reload();
    }
    updateUI();
  };
})();

// --- Monthly clock that only emits decisions found in _decisionsByMonth for that month ---
(function wireMonthlyFRUS(){
  let monthTimer = null;
  let lastDecisionKey = null; // "YYYY-MM" guard so we only trigger once per month

  function nextMonth(y,m){ m++; if (m>12){ m=1; y++; } return { y, m }; }
  function inRange(y,m){
    const toNum = (Y,M)=>Y*100+M;
    const start = toNum(1985, 1);
    const end   = toNum(END_FRAME.y, END_FRAME.m);
    const cur   = toNum(y, m);
    return cur>=start && cur<=end;
  }

  function monthLabel(m){
    const full = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    return full[m-1] || m;
  }

  async function tick(){
    if (!gameState.gameStarted) return;

    // advance
    const nm = nextMonth(gameState.year, gameState.month);
    gameState.year = nm.y;
    gameState.month = nm.m;

    addMessage(`Monthly update: ${monthLabel(gameState.month)} ${gameState.year}.`, '');

    // Only pull a decision that actually exists for this month in FRUS
    const key = `${gameState.year}-${String(gameState.month).padStart(2, '0')}`;
    if (key !== lastDecisionKey && window._decisionsByMonth instanceof Map) {
      const docs = _decisionsByMonth.get(key) || [];
      if (docs.length) {
        // Prefer ABM/SDI/Congress/military documents (weighting)
        const weight = (x)=>(x.isABM?4:0)+(x.isBudget?3:0)+(x.isReyk?3:0)+(x.isService?2:0)+(x.isTech?1:0);
        const top = docs.slice().sort((a,b)=>weight(b)-weight(a))[0];
        const dec = buildDecision(top);
        triggerDecision({
          id: dec.id,
          year: dec.year,
          title: `${dec.title} — ${monthLabel(dec.month||gameState.month)} ${dec.year}`,
          text: dec.text,
          options: dec.options
        });
        lastDecisionKey = key;
      } else {
        // No FRUS decision this month — do nothing (no fake cards)
      }
    } else {
      // TEI not loaded yet — silently skip (no fake cards)
    }

    updateUI();

    // end-of-scenario guard
    if (!inRange(gameState.year, gameState.month)) {
      clearInterval(monthTimer);
      if (gameState.defense >= 50) {
        alert('MISSION ACCOMPLISHED\n\nYou successfully developed and deployed the Strategic Defense Initiative.\n\nFinal Defense Capability: ' + gameState.defense + '%\nTechnologies Deployed: ' + gameState.technologies.length);
      } else {
        alert('PROGRAM TERMINATED\n\nSDI failed to achieve minimum viable defense capability.\n\nFinal Defense Capability: ' + gameState.defense + '%');
      }
    }
  }

  // start the monthly loop when the player starts
  const _start = window.startGame;
  window.startGame = function(){
    _start();
    // force Jan 1985 start (if not already)
    gameState.year = 1985;
    gameState.month = 1;
    updateUI();
    if (monthTimer) clearInterval(monthTimer);
    monthTimer = setInterval(tick, MONTH_TICK_MS);
  };
})();
</script>

</body>
</html>






















